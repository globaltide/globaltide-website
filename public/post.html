<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>글 보기 - GlobalTide Board</title>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

<style>
  :root{ --border:#e5e7eb; --bg:#f9fafb; }

  body{margin:0;font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif;background:var(--bg);color:#111;}
  header{
    padding:10px 14px;background:#fff;border-bottom:1px solid var(--border);
    position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;
    gap:10px;
  }
  .back-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#111;}
  .logo a{color:#111;text-decoration:none;font-weight:700;border:1px solid var(--border);padding:5px 10px;border-radius:8px;}
  .header-right{display:flex;align-items:center;gap:8px;min-width:90px;justify-content:flex-end;}
  .pill{
    border:1px solid var(--border);
    background:#fff;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    color:#444;
    white-space:nowrap;
  }

  .container{
    max-width:800px;margin:20px auto;padding:20px;background:#fff;border:1px solid var(--border);
    border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);
  }
  .post-title{font-size:22px;font-weight:800;margin:0 0 8px;}
  .post-meta{
    font-size:13px;color:#666;margin-bottom:16px;
    display:flex;flex-wrap:wrap;gap:8px;align-items:center;
  }

  .post-content{font-size:16px;line-height:1.85;}
  .post-content.html a{color:#0a66c2;text-decoration:none;}
  .post-content.plain a{color:#0a66c2;text-decoration:none;}
  .no-post{text-align:center;padding:60px;color:#888;font-size:16px;}

  .actions{
    display:none;
    margin-top:18px;
    padding-top:14px;
    border-top:1px solid var(--border);
    gap:10px;
    justify-content:flex-end;
  }
  .btn{
    padding:10px 14px;
    border-radius:10px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    font-weight:700;
    font-size:14px;
    color:#111;
  }
  .btn.primary{ background:#111;color:#fff;border-color:#111; }
  .btn.danger{ background:#fff;color:#e74c3c;border-color:#f1c0bb; }

  /* ✅ Modal (스크롤/고정) */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,0.35);
    display:none;align-items:center;justify-content:center;z-index:1000;
    padding:16px;
    overflow:auto;
  }
  .modal{
    width:100%;
    max-width:820px;
    background:#fff;
    border-radius:14px;
    border:1px solid var(--border);
    box-shadow:0 12px 40px rgba(0,0,0,0.2);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    max-height:calc(100vh - 32px);
  }
  .modal-header{
    padding:12px 14px;
    border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;
    background:#fff;
    gap:10px;
  }
  .modal-header h3{margin:0;font-size:16px;font-weight:800;}
  .modal-body{
    padding:14px;
    overflow:auto;
    flex:1;
  }
  .field{margin-bottom:12px;}

  /* ✅ write.html과 동일한 키워드 라벨 줄 */
  .label-row{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:6px;
  }
  .label-row .label{
    font-size:12px;
    font-weight:800;
    color:#555;
  }
  .label-row .ex{
    font-size:12px;
    font-weight:800;
    color:#777;
  }
  .kw-chip{
    border:1px solid var(--border);
    background:#f9fafb;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:800;
    cursor:pointer;
    white-space:nowrap;
    color:#111 !important;
    appearance:none;
    -webkit-appearance:none;
  }
  .kw-chip:hover{ border-color:#111; }
  .kw-chip:active,
  .kw-chip:focus{
    color:#111 !important;
    outline:none;
  }

  .field input{
    width:100%;
    box-sizing:border-box;
    border:1px solid #ddd;
    border-radius:10px;
    padding:10px 12px;
    font-size:14px;
    font-family:inherit;
    color:#111;
    background:#fff;
  }

  textarea{
    width:100%;
    box-sizing:border-box;
    border:1px solid #ddd;
    border-radius:10px;
    padding:10px 12px;
    font-size:14px;
    font-family:inherit;
    min-height:240px;
    resize:vertical;
    line-height:1.6;
    color:#111;
    background:#fff;
  }

  /* ✅ 원본 편집기: 붙여넣은 글이 "그대로 보이게" */
  .html-editor{
    width:100%;
    box-sizing:border-box;
    border:1px solid #ddd;
    border-radius:10px;
    padding:10px 12px;
    font-size:14px;
    font-family:inherit;
    min-height:240px;
    line-height:1.6;
    overflow:auto;
    outline:none;
    color:#111;
    background:#fff;
  }
  .html-editor a{ color:#0a66c2; text-decoration:none; }
  .hidden{display:none !important;}

  .modebar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .mode-btn{
    border:1px solid var(--border);
    background:#f9fafb;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:800;
    cursor:pointer;
    color:#111;
  }
  .mode-btn.active{background:#111;color:#fff;border-color:#111;}
  .mode-hint{font-size:12px;color:#666;white-space:nowrap;}

  .modal-footer{
    padding:12px 14px;
    border-top:1px solid var(--border);
    display:flex;gap:10px;justify-content:flex-end;
    background:#fff;
  }

  .tabbar{
    position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);
    display:flex;gap:6px;padding:8px;justify-content:center;z-index:10;
  }
  .tabbar a{
    text-decoration:none;padding:8px 16px;border:1px solid var(--border);
    border-radius:10px;background:#f9fafb;color:#111;font-size:14px;
  }
  .tabbar a.active{background:#111;color:#fff;border-color:#111;}
</style>
</head>
<body>

<header>
  <button class="back-btn" onclick="history.back()">←</button>
  <div class="logo"><a href="/">Global Tide</a></div>
  <div class="header-right">
    <div class="pill" id="viewPill">Views 0</div>
  </div>
</header>

<div class="container">
  <div id="postContent">
    <div class="no-post">로딩 중...</div>
  </div>

  <div class="actions" id="actions">
    <button class="btn" id="editBtn">수정</button>
    <button class="btn danger" id="deleteBtn">삭제</button>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-backdrop" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <div style="display:flex;flex-direction:column;gap:8px;flex:1;min-width:0;">
        <h3 style="margin:0;">글 수정</h3>
        <div class="modebar">
          <button type="button" class="mode-btn" id="modePlain">메모장</button>
          <button type="button" class="mode-btn" id="modeHtml">원본</button>
          <span class="mode-hint" id="modeHint">메모장: 텍스트 그대로 저장</span>
        </div>
      </div>
      <button class="btn" id="closeModalBtn" style="padding:6px 10px;">닫기</button>
    </div>

    <div class="modal-body">
      <div class="field">
        <!-- ✅ write.html과 동일 -->
        <div class="label-row">
          <span class="label">키워드</span>
          <span class="ex">: ex)</span>
          <button type="button" class="kw-chip" data-kw="투자자소식">투자자소식</button>
          <button type="button" class="kw-chip" data-kw="뉴스">뉴스</button>
        </div>
        <input id="editKeyword" placeholder="예: Private Credit" />
      </div>

      <div class="field">
        <div class="label-row"><span class="label">제목</span></div>
        <input id="editTitle" placeholder="제목" />
      </div>

      <div class="field">
        <div class="label-row"><span class="label">내용</span></div>

        <!-- plain -->
        <textarea id="editPlain" placeholder="내용(텍스트)"></textarea>

        <!-- html: 코드가 아니라 "보이는 글" 그대로 -->
        <div id="editHtml" class="html-editor hidden" contenteditable="true"></div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn" id="cancelEditBtn">취소</button>
      <button class="btn primary" id="saveEditBtn">저장</button>
    </div>
  </div>
</div>

<!-- 하단 탭 -->
<div class="tabbar">
  <a href="board.html" class="active">Board</a>
  <a href="now.html">Now</a>
  <a href="search.html">Search</a>
</div>

<script>
  const SUPABASE_URL = 'https://toppqscjkkmmelpngzda.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_4eEtjEs8RtBFFWnpdTwRfg_DkXpAa7g';
  const ADMIN_EMAIL = 'seungki.jeong.invest@gmail.com';

  const HTML_MARKER = '__HTML__\\n';

  const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const urlParams = new URLSearchParams(window.location.search);
  const postId = urlParams.get('id');

  let postCache = null;
  let currentUser = null;
  let editMode = 'plain'; // plain | html

  function escapeHTML(s){
    return (s ?? '')
      .toString()
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // ✅ URL을 클릭 가능한 링크로 변환하는 함수
  function linkifyText(text) {
    // URL 패턴: http://, https://, www. 로 시작하는 URL 감지
    const urlPattern = /(https?:\/\/[^\s]+)|(www\.[^\s]+)/gi;
    
    return text.replace(urlPattern, function(url) {
      let href = url;
      // www로 시작하면 https:// 추가
      if (url.startsWith('www.')) {
        href = 'https://' + url;
      }
      return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
  }

  // ✅ 화면 표시/편집에 쓰는 sanitize (script 제거 등)
  function sanitizeHtml(inputHtml){
    const parser = new DOMParser();
    const doc = parser.parseFromString(inputHtml || '', 'text/html');

    const badTags = ['script','style','iframe','object','embed','link','meta','base'];
    badTags.forEach(tag => doc.querySelectorAll(tag).forEach(n => n.remove()));

    const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);
    const toClean = [];
    while (walker.nextNode()) toClean.push(walker.currentNode);

    toClean.forEach(el => {
      [...el.attributes].forEach(attr => {
        const name = attr.name.toLowerCase();
        const val  = (attr.value || '').trim();

        if (name.startsWith('on')) el.removeAttribute(attr.name);

        if (name === 'href' || name === 'src') {
          const v = val.toLowerCase();
          if (v.startsWith('javascript:') || v.startsWith('data:text/html')) {
            el.removeAttribute(attr.name);
          }
        }
        if (name === 'style') el.removeAttribute(attr.name);
      });

      if (el.tagName.toLowerCase() === 'a') {
        el.setAttribute('target','_blank');
        el.setAttribute('rel','noopener noreferrer');
      }
    });

    return doc.body.innerHTML || '';
  }

  async function loadSession(){
    const { data } = await client.auth.getSession();
    currentUser = data?.session?.user ?? null;
  }

  function canManagePost(post){
    if (!currentUser) return false;
    if (currentUser.email === ADMIN_EMAIL) return true;
    if (post?.user_id && currentUser.id === post.user_id) return true;
    return false;
  }

  async function trackView(){
    try{
      await client.from('page_views').insert({
        path: window.location.pathname,
        referrer: document.referrer || null,
        user_agent: navigator.userAgent || null,
        post_id: Number(postId)
      });
    }catch(e){
      console.warn('trackView failed', e);
    }
  }

  async function loadViewCount(){
    try{
      const { count, error } = await client
        .from('page_views')
        .select('id', { count: 'exact', head: true })
        .eq('post_id', Number(postId));

      if (!error && typeof count === 'number'){
        document.getElementById('viewPill').textContent = 'Views ' + count;
      }
    }catch(e){
      console.warn('loadViewCount failed', e);
    }
  }

  function setMode(mode){
    editMode = mode;
    const isPlain = mode === 'plain';

    document.getElementById('modePlain').classList.toggle('active', isPlain);
    document.getElementById('modeHtml').classList.toggle('active', !isPlain);

    document.getElementById('editPlain').classList.toggle('hidden', !isPlain);
    document.getElementById('editHtml').classList.toggle('hidden', isPlain);

    document.getElementById('modeHint').textContent = isPlain
      ? '메모장: 텍스트 그대로 저장'
      : '원본: 링크/서식이 있는 글을 원래 형태로 저장';
  }

  async function loadPost(){
    const container = document.getElementById('postContent');

    if (!postId) {
      container.innerHTML = '<div class="no-post">잘못된 접근입니다</div>';
      return;
    }

    const { data: post, error } = await client
      .from('board_posts')
      .select('*')
      .eq('id', postId)
      .single();

    if (error || !post) {
      container.innerHTML = '<div class="no-post">글을 찾을 수 없습니다</div>';
      return;
    }

    postCache = post;

    const createdAt = post.created_at
      ? new Date(post.created_at).toLocaleDateString('ko-KR')
      : '';

    const isHtml = (post.content || '').startsWith(HTML_MARKER);
    const rawBody = isHtml ? post.content.slice(HTML_MARKER.length) : (post.content || '');

    // ✅ plain 모드: escape 후 linkify 적용, 줄바꿈도 <br>로 변환
    const bodyHtml = isHtml
      ? `<div class="post-content html">${sanitizeHtml(rawBody)}</div>`
      : `<div class="post-content plain">${linkifyText(escapeHTML(rawBody).replace(/\n/g, '<br>'))}</div>`;

    container.innerHTML = `
      <div class="post-title">[${escapeHTML(post.keyword || '기타')}] ${escapeHTML(post.title)}</div>
      <div class="post-meta">
        <span>${escapeHTML(post.author_name || '관리자')}</span>
        <span>·</span>
        <span>${escapeHTML(createdAt)}</span>
        <span>·</span>
        <span id="metaViews">조회수 로딩...</span>
      </div>
      ${bodyHtml}
    `;

    // 권한 있으면 수정/삭제 노출
    const actions = document.getElementById('actions');
    if (canManagePost(post)) actions.style.display = 'flex';

    // ✅ 편집 필드 채우기
    document.getElementById('editKeyword').value = post.keyword || '';
    document.getElementById('editTitle').value = post.title || '';

    if (isHtml){
      // ✅ 핵심: HTML 글이면 textarea에 넣지 말고, 원본 모드로 열어서 "보이는 글"로 채움
      document.getElementById('editPlain').value = '';
      document.getElementById('editHtml').innerHTML = sanitizeHtml(rawBody);
      setMode('html');
    } else {
      document.getElementById('editPlain').value = rawBody;
      document.getElementById('editHtml').innerHTML = '';
      setMode('plain');
    }

    await loadViewCount();
    const pillText = document.getElementById('viewPill').textContent;
    const metaViews = document.getElementById('metaViews');
    if (metaViews) metaViews.textContent = pillText.replace('Views', '조회수');
  }

  function openEditModal(){
    if (!postCache) return;
    document.getElementById('editModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeEditModal(){
    document.getElementById('editModal').style.display = 'none';
    document.body.style.overflow = '';
  }

  async function saveEdit(){
    if (!postCache) return;

    const keyword = document.getElementById('editKeyword').value.trim();
    const title = document.getElementById('editTitle').value.trim();

    if (!title){
      alert('제목을 입력해주세요');
      return;
    }

    let content = '';
    if (editMode === 'plain'){
      content = document.getElementById('editPlain').value.trim();
    } else {
      const raw = document.getElementById('editHtml').innerHTML || '';
      const cleaned = sanitizeHtml(raw).trim();
      content = cleaned ? (HTML_MARKER + cleaned) : '';
    }

    if (!content){
      alert('내용을 입력해주세요');
      return;
    }

    const { error } = await client
      .from('board_posts')
      .update({ keyword: keyword || null, title, content })
      .eq('id', postCache.id);

    if (error){
      console.error(error);
      alert('저장 중 오류가 발생했습니다');
      return;
    }

    closeEditModal();
    await loadPost();
  }

  async function deletePost(){
    if (!postCache) return;
    if (!confirm('정말 삭제할까요?')) return;

    const { error } = await client
      .from('board_posts')
      .delete()
      .eq('id', postCache.id);

    if (error){
      console.error(error);
      alert('삭제 중 오류가 발생했습니다');
      return;
    }

    alert('삭제되었습니다');
    location.href = 'board.html';
  }

  // ✅ 키워드 칩 클릭 => 입력칸 채우기 (write.html과 동일)
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.kw-chip');
    if (!btn) return;
    const v = btn.dataset.kw || '';
    const input = document.getElementById('editKeyword');
    input.value = v;
    input.focus();
  });

  // events
  document.getElementById('editBtn').addEventListener('click', openEditModal);
  document.getElementById('deleteBtn').addEventListener('click', deletePost);
  document.getElementById('closeModalBtn').addEventListener('click', closeEditModal);
  document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
  document.getElementById('saveEditBtn').addEventListener('click', saveEdit);

  document.getElementById('modePlain').addEventListener('click', () => setMode('plain'));
  document.getElementById('modeHtml').addEventListener('click', () => setMode('html'));

  // init
  (async function init(){
    await loadSession();
    await trackView();
    await loadPost();
  })();
</script>

</body>
</html>
