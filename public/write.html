<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>글쓰기 - GlobalTide Board</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

<style>
  body{
    margin:0;
    font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif;
    background:#f9fafb;
    color:#111;
  }
  header{
    padding:10px 14px;
    background:#fff;
    border-bottom:1px solid #e5e7eb;
    position:sticky;
    top:0;
    z-index:10;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .back-btn{
    background:none;
    border:none;
    font-size:24px;
    cursor:pointer;
    color:#111;
  }
  .logo a{
    color:#111;
    text-decoration:none;
    font-weight:700;
  }
  .container{
    max-width:800px;
    margin:20px auto;
    padding:20px;
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:12px;
  }
  h2{
    font-size:20px;
    font-weight:700;
    margin-bottom:16px;
  }

  input, textarea{
    width:100%;
    padding:14px;
    border:1px solid #ddd;
    border-radius:10px;
    margin-bottom:16px;
    font-size:15px;
    box-sizing:border-box;
    font-family:inherit;
    color:#111;
    background:#fff;
  }
  textarea{
    min-height:360px;
    resize:vertical;
    line-height:1.6;
  }

  .field{ margin-bottom:16px; }
  .label-row{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:6px;
  }
  .label-row .label{
    font-size:12px;
    font-weight:800;
    color:#555;
  }
  .label-row .ex{
    font-size:12px;
    font-weight:800;
    color:#777;
  }

  /* ✅ 칩 글자색 강제 고정 (흰색으로 바뀌는 문제 해결) */
  .kw-chip{
    border:1px solid #e5e7eb;
    background:#f9fafb;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:800;
    cursor:pointer;
    white-space:nowrap;
    color:#111 !important;
    appearance:none;
    -webkit-appearance:none;
  }
  .kw-chip:hover{ border-color:#111; }
  .kw-chip:active,
  .kw-chip:focus{
    color:#111 !important;
    outline:none;
  }

  .modebar{
    display:flex;
    gap:8px;
    margin-bottom:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .mode-btn{
    border:1px solid #e5e7eb;
    background:#f9fafb;
    padding:8px 12px;
    border-radius:999px;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
    color:#111;
  }
  .mode-btn.active{
    background:#111;
    color:#fff;
    border-color:#111;
  }
  .hint{
    font-size:12px;
    color:#666;
    margin-left:auto;
    white-space:nowrap;
  }

  .html-editor{
    width:100%;
    min-height:360px;
    border:1px solid #ddd;
    border-radius:10px;
    padding:14px;
    box-sizing:border-box;
    font-size:15px;
    line-height:1.6;
    outline:none;
    background:#fff;
    margin-bottom:16px;
    overflow:auto;
    color:#111;
  }
  .html-editor:empty:before{
    content:attr(data-placeholder);
    color:#999;
  }
  .hidden{ display:none !important; }

  button{
    padding:14px 28px;
    background:#111;
    color:#fff;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
  }
  button:hover{ background:#333; }
  button:disabled{ background:#999; cursor:not-allowed; }

  .msg{
    margin-top:10px;
    padding:10px;
    border-radius:8px;
    font-size:14px;
  }
  .error{ background:#ffeaea; color:#d00; }
  .success{ background:#eaffea; color:#070; }
</style>
</head>
<body>

<header>
  <button class="back-btn" onclick="history.back()">←</button>
  <div class="logo"><a href="/">Global Tide</a></div>
  <div></div>
</header>

<div class="container">
  <h2>새 글 쓰기</h2>

  <input type="text" id="title" placeholder="제목을 입력하세요" />

  <div class="field">
    <div class="label-row">
      <span class="label">키워드</span>
      <span class="ex">: ex)</span>
      <button type="button" class="kw-chip" data-kw="투자자소식">투자자소식</button>
      <button type="button" class="kw-chip" data-kw="뉴스">뉴스</button>
    </div>
    <input type="text" id="keyword" placeholder="키워드 (선택)" style="margin-bottom:0;" />
  </div>

  <div class="modebar">
    <button type="button" class="mode-btn active" id="modePlainBtn">메모장</button>
    <button type="button" class="mode-btn" id="modeHtmlBtn">원본</button>
    <div class="hint" id="modeHint">메모장: 붙여넣기 시 텍스트만 저장</div>
  </div>

  <textarea id="contentPlain" placeholder="내용을 작성하세요 (텍스트 그대로 저장)"></textarea>

  <div id="contentHtml"
       class="html-editor hidden"
       contenteditable="true"
       data-placeholder="원본 모드: 링크/서식이 있는 글을 그대로 붙여넣으세요"></div>

  <button id="saveBtn" disabled onclick="savePost()">등록하기</button>
  <div id="msg" class="msg" style="display:none;"></div>
</div>

<script>
  const SUPABASE_URL = 'https://toppqscjkkmmelpngzda.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_4eEtjEs8RtBFFWnpdTwRfg_DkXpAa7g';
  const ADMIN_EMAIL = 'seungki.jeong.invest@gmail.com';

  const HTML_MARKER = '__HTML__\\n';

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const modePlainBtn = document.getElementById('modePlainBtn');
  const modeHtmlBtn  = document.getElementById('modeHtmlBtn');
  const modeHint     = document.getElementById('modeHint');

  const contentPlain = document.getElementById('contentPlain');
  const contentHtml  = document.getElementById('contentHtml');

  const keywordInput = document.getElementById('keyword');

  let currentMode = 'plain'; // plain | html

  document.querySelectorAll('.kw-chip').forEach(btn => {
    btn.addEventListener('click', () => {
      keywordInput.value = btn.dataset.kw || '';
      keywordInput.focus();
    });
  });

  function setMode(mode){
    currentMode = mode;

    const isPlain = mode === 'plain';
    modePlainBtn.classList.toggle('active', isPlain);
    modeHtmlBtn.classList.toggle('active', !isPlain);

    contentPlain.classList.toggle('hidden', !isPlain);
    contentHtml.classList.toggle('hidden', isPlain);

    modeHint.textContent = isPlain
      ? '메모장: 붙여넣기 시 텍스트만 저장'
      : '원본: 링크/서식이 있는 글을 변형 최소로 저장 (안전하게 정리 후 저장)';
  }

  modePlainBtn.addEventListener('click', () => setMode('plain'));
  modeHtmlBtn.addEventListener('click', () => setMode('html'));

  contentPlain.addEventListener('paste', (e) => {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text/plain') || '';
    const start = contentPlain.selectionStart;
    const end = contentPlain.selectionEnd;
    const v = contentPlain.value;
    contentPlain.value = v.slice(0, start) + text + v.slice(end);
    const cursor = start + text.length;
    contentPlain.setSelectionRange(cursor, cursor);
  });

  function sanitizeHtml(inputHtml){
    const parser = new DOMParser();
    const doc = parser.parseFromString(inputHtml || '', 'text/html');

    const badTags = ['script','style','iframe','object','embed','link','meta','base'];
    badTags.forEach(tag => doc.querySelectorAll(tag).forEach(n => n.remove()));

    const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);
    const toClean = [];
    while (walker.nextNode()) toClean.push(walker.currentNode);

    toClean.forEach(el => {
      [...el.attributes].forEach(attr => {
        const name = attr.name.toLowerCase();
        const val  = (attr.value || '').trim();

        if (name.startsWith('on')) el.removeAttribute(attr.name);

        if (name === 'href' || name === 'src') {
          const v = val.toLowerCase();
          if (v.startsWith('javascript:') || v.startsWith('data:text/html')) {
            el.removeAttribute(attr.name);
          }
        }
        if (name === 'style') el.removeAttribute(attr.name);
      });

      if (el.tagName.toLowerCase() === 'a') {
        el.setAttribute('target','_blank');
        el.setAttribute('rel','noopener noreferrer');
      }
    });

    return doc.body.innerHTML || '';
  }

  function getPayloadContent(){
    if (currentMode === 'plain') {
      return contentPlain.value.trim();
    }
    const raw = contentHtml.innerHTML || '';
    const cleaned = sanitizeHtml(raw).trim();
    return cleaned ? (HTML_MARKER + cleaned) : '';
  }

  function showMsg(text, type) {
    const msg = document.getElementById('msg');
    msg.textContent = text;
    msg.className = 'msg ' + type;
    msg.style.display = 'block';
  }

  supabaseClient.auth.getSession().then(({ data, error }) => {
    if (error) {
      showMsg('세션 확인 중 오류: ' + error.message, 'error');
      return;
    }
    const session = data.session;
    if (session && session.user && session.user.email === ADMIN_EMAIL) {
      document.getElementById('saveBtn').disabled = false;
    } else {
      showMsg('글쓰기는 관리자만 가능합니다', 'error');
      setTimeout(() => location.href = 'board.html', 2000);
    }
  });

  async function savePost() {
    const title = document.getElementById('title').value.trim();
    const keyword = keywordInput.value.trim();
    const content = getPayloadContent();

    if (!title || !content) {
      showMsg('제목과 내용을 입력해주세요', 'error');
      return;
    }

    const { data, error: userError } = await supabaseClient.auth.getUser();
    if (userError) {
      showMsg('유저 정보 확인 실패: ' + userError.message, 'error');
      return;
    }

    const user = data.user;
    if (!user || user.email !== ADMIN_EMAIL) {
      showMsg('권한이 없습니다', 'error');
      return;
    }

    const { error } = await supabaseClient
      .from('board_posts')
      .insert({
        user_id: user.id,
        title,
        keyword: keyword || null,
        content,
        author_name: '관리자'
      });

    if (error) {
      showMsg('저장 실패: ' + error.message, 'error');
    } else {
      showMsg('글이 등록되었습니다!', 'success');
      setTimeout(() => location.href = 'board.html', 1500);
    }
  }

  window.savePost = savePost;
</script>

</body>
</html>
