<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>RFP Monitor | GlobalTide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script defer src="/nav-top.js"></script>
  <script defer src="/nav-bottom.js"></script>

  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0b1020;color:#e5e7eb}
    main{max-width:1200px;margin:0 auto;padding:24px 14px;
      padding-top:calc(var(--gt-topnav-h,56px)+20px);
      padding-bottom:calc(var(--gt-bottomnav-h,64px)+20px)}
    
    .header-section{margin-bottom:24px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:24px}
    .stat-card{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);
      border-radius:12px;padding:16px;text-align:center}
    .stat-number{font-size:28px;font-weight:700;color:#60a5fa;margin:0}
    .stat-label{font-size:13px;color:#9ca3af;margin-top:4px}
    
    .controls{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
      border-radius:14px;padding:18px;margin-bottom:20px;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .search-box{flex:1;min-width:200px;padding:10px 14px;background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#e5e7eb;font-size:14px}
    .search-box::placeholder{color:#9ca3af}
    
    .filter-group{display:flex;gap:8px;flex-wrap:wrap}
    .filter-btn{padding:8px 16px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
      border-radius:8px;color:#e5e7eb;cursor:pointer;font-size:13px;transition:all .2s}
    .filter-btn:hover{background:rgba(255,255,255,.12)}
    .filter-btn.active{background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.5);color:#60a5fa}
    
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
      border-radius:14px;padding:20px;margin-bottom:16px}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px}
    .badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase}
    .badge-domestic{background:rgba(34,197,94,.2);color:#4ade80;border:1px solid rgba(34,197,94,.3)}
    .badge-global{background:rgba(147,51,234,.2);color:#a855f7;border:1px solid rgba(147,51,234,.3)}
    .badge-urgent{background:rgba(239,68,68,.2);color:#f87171;border:1px solid rgba(239,68,68,.3);margin-left:8px}
    
    h1{font-size:28px;margin:0 0 8px 0;font-weight:700}
    .subtitle{color:#9ca3af;font-size:14px;margin-bottom:20px}
    h2{font-size:18px;margin:0;font-weight:600;color:#e5e7eb}
    .count{color:#9ca3af;font-size:14px;font-weight:400;margin-left:8px}
    
    .rfp-list{list-style:none;padding:0;margin:0}
    .rfp-item{padding:14px 0;border-bottom:1px solid rgba(255,255,255,.08)}
    .rfp-item:last-child{border-bottom:none}
    .rfp-institution{font-weight:600;color:#60a5fa;font-size:15px;margin-bottom:4px}
    .rfp-details{color:#d1d5db;font-size:13px;line-height:1.6}
    .rfp-meta{display:flex;gap:16px;margin-top:6px;flex-wrap:wrap}
    .meta-item{color:#9ca3af;font-size:12px}
    .meta-item strong{color:#e5e7eb;margin-right:4px}
    
    .source-link{color:#93c5fd;text-decoration:none;font-size:13px;transition:color .2s}
    .source-link:hover{color:#60a5fa;text-decoration:underline}
    
    .empty-state{text-align:center;padding:40px;color:#9ca3af}
    .loading{text-align:center;padding:40px;color:#9ca3af}
    
    @media (max-width: 640px) {
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      .controls{flex-direction:column;align-items:stretch}
      .search-box{width:100%}
      h1{font-size:24px}
    }
  </style>
</head>
<body>
<main>
  <div class="header-section">
    <h1>ğŸ” RFP Monitor</h1>
    <p class="subtitle">ì‹¤ì‹œê°„ êµ­ë‚´ì™¸ ê¸°ê´€íˆ¬ìì RFP ê³µê³  ëª¨ë‹ˆí„°ë§</p>
  </div>

  <div class="stats-grid" id="stats">
    <div class="stat-card">
      <div class="stat-number" id="total-count">-</div>
      <div class="stat-label">ì „ì²´ ê³µê³ </div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="domestic-count">-</div>
      <div class="stat-label">êµ­ë‚´ ê¸°ê´€</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="global-count">-</div>
      <div class="stat-label">ê¸€ë¡œë²Œ ì—°ê¸°ê¸ˆ</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="urgent-count">-</div>
      <div class="stat-label">ë§ˆê° ì„ë°•</div>
    </div>
  </div>

  <div class="controls">
    <input type="text" class="search-box" id="search" placeholder="ê¸°ê´€ëª…, ìì‚°êµ°, ì§€ì—­ìœ¼ë¡œ ê²€ìƒ‰...">
    <div class="filter-group">
      <button class="filter-btn active" data-filter="all">ì „ì²´</button>
      <button class="filter-btn" data-filter="domestic">êµ­ë‚´</button>
      <button class="filter-btn" data-filter="global">ê¸€ë¡œë²Œ</button>
      <button class="filter-btn" data-filter="urgent">ë§ˆê°ì„ë°•</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div>
        <h2>êµ­ë‚´ ê¸°ê´€ <span class="count" id="dom-count">0ê±´</span></h2>
      </div>
    </div>
    <ul class="rfp-list" id="dom">
      <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </ul>
  </div>

  <div class="card">
    <div class="card-header">
      <div>
        <h2>ê¸€ë¡œë²Œ ì—°ê¸°ê¸ˆ <span class="count" id="glo-count">0ê±´</span></h2>
      </div>
    </div>
    <ul class="rfp-list" id="glo">
      <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </ul>
  </div>
</main>

<script>
let allData = { domestic: [], global: [] };
let currentFilter = 'all';
let searchQuery = '';

function isUrgent(deadline) {
  const deadlineDate = new Date(deadline);
  const today = new Date();
  const diff = (deadlineDate - today) / (1000 * 60 * 60 * 24);
  return diff <= 7 && diff >= 0;
}

function renderRFPItem(item, type) {
  const urgent = isUrgent(item.deadline);
  const badgeType = type === 'domestic' ? 'badge-domestic' : 'badge-global';
  const urgentBadge = urgent ? '<span class="badge badge-urgent">ë§ˆê°ì„ë°•</span>' : '';
  
  return `
    <li class="rfp-item" data-type="${type}" data-urgent="${urgent}">
      <div class="rfp-institution">
        <span class="badge ${badgeType}">${type === 'domestic' ? 'êµ­ë‚´' : 'ê¸€ë¡œë²Œ'}</span>
        ${urgentBadge}
        ${item.institution}
      </div>
      <div class="rfp-details">${item.asset}</div>
      <div class="rfp-meta">
        <span class="meta-item"><strong>ì§€ì—­:</strong> ${item.region}</span>
        <span class="meta-item"><strong>ë§ˆê°:</strong> ${item.deadline}</span>
        ${item.amount ? `<span class="meta-item"><strong>ê·œëª¨:</strong> ${item.amount}</span>` : ''}
      </div>
      <a href="${item.source}" target="_blank" class="source-link" rel="noopener noreferrer">
        ğŸ“„ ê³µê³  ì›ë¬¸ ë³´ê¸° â†’
      </a>
    </li>
  `;
}

function applyFilters() {
  let domesticFiltered = allData.domestic;
  let globalFiltered = allData.global;
  
  if (searchQuery) {
    const query = searchQuery.toLowerCase();
    domesticFiltered = domesticFiltered.filter(item => 
      item.institution.toLowerCase().includes(query) ||
      item.asset.toLowerCase().includes(query) ||
      item.region.toLowerCase().includes(query)
    );
    globalFiltered = globalFiltered.filter(item => 
      item.institution.toLowerCase().includes(query) ||
      item.asset.toLowerCase().includes(query) ||
      item.region.toLowerCase().includes(query)
    );
  }
  
  if (currentFilter === 'domestic') {
    globalFiltered = [];
  } else if (currentFilter === 'global') {
    domesticFiltered = [];
  } else if (currentFilter === 'urgent') {
    domesticFiltered = domesticFiltered.filter(item => isUrgent(item.deadline));
    globalFiltered = globalFiltered.filter(item => isUrgent(item.deadline));
  }
  
  renderLists(domesticFiltered, globalFiltered);
}

function renderLists(domesticData, globalData) {
  const domElement = document.getElementById('dom');
  const gloElement = document.getElementById('glo');
  
  if (domesticData.length === 0) {
    domElement.innerHTML = '<div class="empty-state">í•´ë‹¹í•˜ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  } else {
    domElement.innerHTML = domesticData.map(x => renderRFPItem(x, 'domestic')).join('');
  }
  
  if (globalData.length === 0) {
    gloElement.innerHTML = '<div class="empty-state">í•´ë‹¹í•˜ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  } else {
    gloElement.innerHTML = globalData.map(x => renderRFPItem(x, 'global')).join('');
  }
  
  document.getElementById('dom-count').textContent = `${domesticData.length}ê±´`;
  document.getElementById('glo-count').textContent = `${globalData.length}ê±´`;
}

function updateStats() {
  const totalCount = allData.domestic.length + allData.global.length;
  const urgentCount = [...allData.domestic, ...allData.global].filter(item => isUrgent(item.deadline)).length;
  
  document.getElementById('total-count').textContent = totalCount;
  document.getElementById('domestic-count').textContent = allData.domestic.length;
  document.getElementById('global-count').textContent = allData.global.length;
  document.getElementById('urgent-count').textContent = urgentCount;
}

fetch("/.netlify/functions/rfp")
  .then(r => r.json())
  .then(data => {
    allData = data;
    updateStats();
    applyFilters();
  })
  .catch(err => {
    console.error('RFP ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
    document.getElementById('dom').innerHTML = '<div class="empty-state">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    document.getElementById('glo').innerHTML = '<div class="empty-state">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
  });

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    applyFilters();
  });
});

document.getElementById('search').addEventListener('input', (e) => {
  searchQuery = e.target.value;
  applyFilters();
});
</script>
</body>
</html>
